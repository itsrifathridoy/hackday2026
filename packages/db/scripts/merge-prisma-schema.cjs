#!/usr/bin/env node
/*
  Simple merge script to generate prisma/schema.prisma from:
  - prisma/base.prisma
  - prisma/models/*.prisma (alphabetical)
*/
const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const prismaDir = path.join(root, 'prisma');
const basePath = path.join(prismaDir, 'base.prisma');
const modelsDir = path.join(prismaDir, 'models');
const outPath = path.join(prismaDir, 'schema.prisma');

function ensureBaseFile(p) {
  if (!fs.existsSync(p)) {
    console.warn(`Missing file: ${p}. Creating a minimal base.prisma...`);
    const minimalBase = `// Base Prisma config shared across models\n\n` +
      `generator client {\n` +
      `  provider = \"prisma-client\"\n` +
      `  output   = \"../generated/prisma\"\n` +
      `}\n\n` +
      `datasource db {\n` +
      `  provider = \"postgresql\"\n` +
      `}\n`;
    fs.writeFileSync(p, minimalBase + "\n", 'utf8');
  }
}

ensureBaseFile(basePath);
if (!fs.existsSync(modelsDir)) {
  fs.mkdirSync(modelsDir, { recursive: true });
}

const base = fs.readFileSync(basePath, 'utf8');
const modelFiles = fs
  .readdirSync(modelsDir)
  .filter((f) => f.endsWith('.prisma'))
  .sort((a, b) => a.localeCompare(b));

const parts = [
  '// prisma/schema.prisma (generated by scripts/merge-prisma-schema.cjs)\n',
  base.trim(),
];

for (const file of modelFiles) {
  const content = fs.readFileSync(path.join(modelsDir, file), 'utf8').trim();
  if (content) {
    parts.push('\n\n// From models/' + file + '\n' + content);
  }
}

const merged = parts.join('\n\n') + '\n';
fs.writeFileSync(outPath, merged, 'utf8');
console.log(`Merged ${modelFiles.length} model file(s) into prisma/schema.prisma`);
